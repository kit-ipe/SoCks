From fc299e1448a4cf1b1ea3f32fd66db3c0740e3928 Mon Sep 17 00:00:00 2001
From: "marvin.fuchs" <marvin.fuchs@kit.edu>
Date: Tue, 20 Feb 2024 23:44:42 +0100
Subject: [PATCH] Strip everything except the rootfs from core-image-minimal

---
 .../include/machine-xilinx-default.inc        | 13 +++++----
 .../conf/machine/zynqmp-generic.conf          | 28 +++++++++++--------
 2 files changed, 23 insertions(+), 18 deletions(-)

diff --git a/meta-xilinx-core/conf/machine/include/machine-xilinx-default.inc b/meta-xilinx-core/conf/machine/include/machine-xilinx-default.inc
index aa91f771..79659ce0 100644
--- a/meta-xilinx-core/conf/machine/include/machine-xilinx-default.inc
+++ b/meta-xilinx-core/conf/machine/include/machine-xilinx-default.inc
@@ -38,12 +38,13 @@ XSERVER ?= " \
 	${XSERVER_EXT} \
 	"
 
-# Automatically add WKS_FILE_DEPENDS based on the configuration
-WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'boot.bin', ' xilinx-bootbin', '', d)}"
-WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'system.dtb', ' virtual/dtb', '', d)}"
-WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'boot.scr', ' u-boot-zynq-scr', '', d)}"
-WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'uEnv.txt', ' u-boot-zynq-uenv', '', d)}"
-WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'atf-uboot.ub', ' arm-trusted-firmware', '', d)}"
+#### Do not add dependencies that are not rootfs related ####
+## Automatically add WKS_FILE_DEPENDS based on the configuration
+#WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'boot.bin', ' xilinx-bootbin', '', d)}"
+#WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'system.dtb', ' virtual/dtb', '', d)}"
+#WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'boot.scr', ' u-boot-zynq-scr', '', d)}"
+#WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'uEnv.txt', ' u-boot-zynq-uenv', '', d)}"
+#WKS_FILE_DEPENDS:append = "${@bb.utils.contains('IMAGE_BOOT_FILES', 'atf-uboot.ub', ' arm-trusted-firmware', '', d)}"
 
 IMAGE_BOOT_FILES ?= "${@get_default_image_boot_files(d)}"
 
diff --git a/meta-xilinx-core/conf/machine/zynqmp-generic.conf b/meta-xilinx-core/conf/machine/zynqmp-generic.conf
index 32de4d50..a13215e2 100644
--- a/meta-xilinx-core/conf/machine/zynqmp-generic.conf
+++ b/meta-xilinx-core/conf/machine/zynqmp-generic.conf
@@ -24,8 +24,9 @@ MACHINE_FEATURES += "rtc ext2 ext3 vfat usbhost"
 # Ultra96 features:
 MACHINE_FEATURES += " usbgadget wifi bluetooth"
 
-# Qemu Xilinx Native when targeting ZynqMP generic requries the pmu rom
-DEPENDS:append:pn-qemu-xilinx-native = " pmu-rom-native"
+#### Do not add dependencies that are not rootfs related ####
+## Qemu Xilinx Native when targeting ZynqMP generic requries the pmu rom
+#DEPENDS:append:pn-qemu-xilinx-native = " pmu-rom-native"
 
 EXTRA_IMAGEDEPENDS += "libyaml-native python3-cython-native python3-pyyaml-native"
 
@@ -41,19 +42,21 @@ WKS_FILES ?= "sdimage-bootpart.wks"
 
 SERIAL_CONSOLES ?= "115200;ttyPS0"
 
-MACHINE_ESSENTIAL_EXTRA_RDEPENDS += "device-tree"
+#### Do not add dependencies that are not rootfs related ####
+#MACHINE_ESSENTIAL_EXTRA_RDEPENDS += "device-tree"
 
 # We need a generic one that works with QEMU...
 HDF_MACHINE = "zcu102-zynqmp"
 
-EXTRA_IMAGEDEPENDS += " \
-		u-boot-zynq-uenv \
-		arm-trusted-firmware \
-		qemu-devicetrees \
-		virtual/boot-bin \
-		virtual/bootloader \
-		u-boot-zynq-scr \
-		"
+#### Do not add dependencies that are not rootfs related ####
+#EXTRA_IMAGEDEPENDS += " \
+#		u-boot-zynq-uenv \
+#		arm-trusted-firmware \
+#		qemu-devicetrees \
+#		virtual/boot-bin \
+#		virtual/bootloader \
+#		u-boot-zynq-scr \
+#		"
 
 IMAGE_BOOT_FILES += " \
 		uEnv.txt \
@@ -87,7 +90,8 @@ QB_PMU_OPT = " \
 		"
 QB_OPT_APPEND += " -pmu-args '${QB_PMU_OPT}'"
 
-do_write_qemuboot_conf[depends] += "u-boot-zynq-uenv:do_deploy"
+#### Do not add dependencies that are not rootfs related ####
+#do_write_qemuboot_conf[depends] += "u-boot-zynq-uenv:do_deploy"
 
 #### No additional settings should be after the Postamble
 #### Postamble
-- 
2.25.1

