#!/bin/sh

INTERFACE="eth0"
ROOT="/mnt/root"

echo "Executing init script of initramfs"
echo "This init script only supports mounting the rootfs via NFS"

# mount temporary filesystems
mount -n -t devtmpfs devtmpfs /dev
mount -n -t proc     proc     /proc
mount -n -t sysfs    sysfs    /sys

# Create variables from Kernel command line parameters
for arg in "$@"; do
  # Split argument into key and value by the '=' sign
  IFS='=' read key value <<EOF
$arg
EOF
  # Declare the variable with its value
  eval "$key=$value"
done

# Check whether all required variables are available
if [ -z ${nfsroot+x} ]; then
  echo "Error: Unable to find parameter 'nfsroot' after '--' in the Kernel command line parameters"
  sleep 0.1
  exit 1
fi

while true; do
  # bring up the network interface 
  ifup eth0

  # Wait until the interface has an IP address
  WAIT_INTERVAL=0.3  # Time to wait between checks
  TIMEOUT=30  # Timeout in wait intervals
  count=0
  while ! ip addr show "$INTERFACE" | grep -q "inet " && [ "$count" -lt "$TIMEOUT" ]; do
    echo "Waiting for IP address on $INTERFACE..."
    sleep $WAIT_INTERVAL
    count=$((count + WAIT_INTERVAL))
  done
  
  # Check whether the timeout was reached 
  if [ "$count" -eq "$TIMEOUT" ]; then
    echo "Interface $INTERFACE did not come up. Try again..."
    # bring down the network interface and try again 
    ifdown eth0
  else
    break
  fi
done

# split variable for NFS mount
IFS=',' read nfsroot_location nfsroot_options <<EOF
$nfsroot
EOF

# mount NFS share
mkdir -p $ROOT
eval "nfsroot_options=nolock,$nfsroot_options"
printf "Mounting NFS share '$nfsroot_location' with options '$nfsroot_options'\n"
mount -t nfs -o $nfsroot_options $nfsroot_location $ROOT

# DEBUGGING
#exec /bin/sh

# switch to new rootfs and exec init
cd $ROOT
exec switch_root . "/sbin/init" "$@"
